#!/usr/bin/env bash
# wallflow-config - Configuration management for wallflow
# Provides easy ways to view, edit, validate, and test configuration

set -euo pipefail

CONFIG_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/wallflow/config.yml"
CONFIG_DIR="$(dirname "$CONFIG_FILE")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo -e "${BLUE}üåä $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_info() {
    echo -e "${PURPLE}‚ÑπÔ∏è $1${NC}"
}

# Get the wallflow installation directory
get_wallflow_dir() {
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    echo "$(dirname "$script_dir")"
}

# Show current configuration
show_config() {
    print_header "wallflow Configuration"
    echo "Config file: $CONFIG_FILE"
    echo ""

    if [[ ! -f "$CONFIG_FILE" ]]; then
        print_error "Config file not found!"
        echo ""
        print_info "Run 'wallflow-config init' to create a default configuration"
        return 1
    fi

    # Show config with syntax highlighting if available
    if command -v bat >/dev/null 2>&1; then
        bat --language yaml --style=plain "$CONFIG_FILE"
    elif command -v pygmentize >/dev/null 2>&1; then
        pygmentize -l yaml "$CONFIG_FILE"
    else
        echo "Configuration contents:"
        echo "----------------------"
        cat "$CONFIG_FILE"
    fi
}

# Initialize configuration
init_config() {
    print_header "Initializing wallflow Configuration"

    if [[ -f "$CONFIG_FILE" ]]; then
        print_warning "Config file already exists: $CONFIG_FILE"
        read -p "Overwrite existing configuration? [y/N]: " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "Configuration initialization cancelled"
            return 0
        fi
    fi

    # Create config directory
    mkdir -p "$CONFIG_DIR"

    # Find the template config
    local wallflow_dir
    wallflow_dir=$(get_wallflow_dir)
    local template_config="$wallflow_dir/config/wallflow.yml"

    if [[ -f "$template_config" ]]; then
        cp "$template_config" "$CONFIG_FILE"
        print_success "Created configuration from template"
    else
        # Fallback: create a minimal config
        cat > "$CONFIG_FILE" << 'EOF'
# wallflow Configuration

# Directories
paths:
  local: "${HOME}/Pictures/Wallpapers"
  downloads: "${HOME}/Pictures/Wallpapers/downloads"

# Transition Settings
transition:
  type:
    - "fade"
    - "wipe"
    - "random"
  duration: 5

# Timer Settings
timer:
  interval: 30
  randomize: "5m"

# Sources
sources:
  default: "wallhaven"
  category: "nature"

# Cleanup
cleanup:
  keep_count: 10

# Logging
logging:
  enabled: true
  level: "info"
EOF
        print_warning "Template not found, created minimal configuration"
    fi

    print_success "Configuration initialized at: $CONFIG_FILE"
}

# Edit configuration
edit_config() {
    print_header "Editing wallflow Configuration"

    if [[ ! -f "$CONFIG_FILE" ]]; then
        print_warning "Config file doesn't exist, initializing first..."
        init_config
    fi

    # Use user's preferred editor or fall back to nano
    EDITOR="${EDITOR:-nano}"
    "$EDITOR" "$CONFIG_FILE"

    print_success "Configuration edit complete"
}

# Validate configuration
validate_config() {
    print_header "Validating wallflow Configuration"

    if [[ ! -f "$CONFIG_FILE" ]]; then
        print_error "Config file not found: $CONFIG_FILE"
        return 1
    fi

    local errors=0

    # Basic YAML syntax check
    if command -v yq >/dev/null 2>&1; then
        if ! yq eval '.' "$CONFIG_FILE" >/dev/null 2>&1; then
            print_error "Invalid YAML syntax"
            ((errors++))
        else
            print_success "YAML syntax is valid"
        fi
    else
        print_warning "yq not found, skipping YAML syntax check"
        print_info "Install yq for comprehensive validation: https://github.com/mikefarah/yq"
    fi

    # Check for required sections
    local required_sections=("paths" "transition" "cleanup" "timer" "sources")
    for section in "${required_sections[@]}"; do
        if grep -q "^${section}:" "$CONFIG_FILE"; then
            print_success "Section '$section' found"
        else
            print_error "Missing required section: $section"
            ((errors++))
        fi
    done

    # Check that directories exist or can be created
    if grep -q "local:" "$CONFIG_FILE"; then
        local dir
        dir=$(grep -A1 "paths:" "$CONFIG_FILE" | grep "local:" | cut -d'"' -f2 | envsubst)
        if [[ -n "$dir" ]]; then
            if [[ -d "$dir" ]] || mkdir -p "$dir" 2>/dev/null; then
                print_success "Local wallpaper directory: $dir"
            else
                print_error "Cannot create local wallpaper directory: $dir"
                ((errors++))
            fi
        fi
    fi

    # Check transition types
    if grep -q "type:" "$CONFIG_FILE"; then
        # Check if it's an array or single value
        if grep -A10 "transition:" "$CONFIG_FILE" | grep -q "^[[:space:]]*-"; then
            print_success "Multiple transition types configured"
        else
            print_success "Single transition type configured"
        fi
    fi

    # Check numeric values
    local numeric_fields=("duration" "keep_count" "interval")
    for field in "${numeric_fields[@]}"; do
        if value=$(grep -E "^[[:space:]]*${field}:" "$CONFIG_FILE" | awk '{print $2}' | tr -d '"'); then
            if [[ "$value" =~ ^[0-9]+$ ]]; then
                print_success "$field: $value (valid number)"
            else
                print_error "$field: '$value' (not a valid number)"
                ((errors++))
            fi
        fi
    done

    echo ""
    if [[ $errors -eq 0 ]]; then
        print_success "Configuration validation passed!"
        return 0
    else
        print_error "Configuration validation failed with $errors errors"
        return 1
    fi
}

# Regenerate systemd services from current configuration
regenerate_services() {
    print_header "Regenerating systemd services"

    if ! validate_config; then
        print_error "Configuration validation failed, cannot regenerate services"
        return 1
    fi

    echo ""
    print_info "Regenerating systemd services from current configuration..."

    # Get wallflow directory - try multiple locations
    local wallflow_dir=""
    local generate_script=""

    # First try: installed location (follow symlinks back to source)
    if command -v wallflow >/dev/null 2>&1; then
        local wallflow_path="$(command -v wallflow)"
        if [[ -L "$wallflow_path" ]]; then
            # Follow symlink back to source
            wallflow_dir="$(dirname "$(dirname "$(readlink -f "$wallflow_path")")")"
        else
            # Assume standard installation structure
            wallflow_dir="$(dirname "$(dirname "$wallflow_path")")"
        fi
    fi

    # Check for script in wallflow directory
    if [[ -n "$wallflow_dir" && -f "$wallflow_dir/scripts/generate-systemd-services.sh" ]]; then
        generate_script="$wallflow_dir/scripts/generate-systemd-services.sh"
    # Try current working directory (development)
    elif [[ -f "./scripts/generate-systemd-services.sh" ]]; then
        generate_script="./scripts/generate-systemd-services.sh"
    # Try relative to this script
    elif [[ -f "$(dirname "$0")/../scripts/generate-systemd-services.sh" ]]; then
        generate_script="$(dirname "$0")/../scripts/generate-systemd-services.sh"
    fi

    if [[ -z "$generate_script" ]]; then
        print_error "Service generation script not found"
        print_info "Tried:"
        print_info "  $wallflow_dir/scripts/generate-systemd-services.sh"
        print_info "  ./scripts/generate-systemd-services.sh"
        print_info "  $(dirname "$0")/../scripts/generate-systemd-services.sh"
        print_info "Try reinstalling wallflow or run from wallflow directory"
        return 1
    fi
    if [[ -f "$generate_script" ]]; then
        if "$generate_script"; then
            print_success "systemd services regenerated successfully!"
            echo ""
            print_info "Services updated with current configuration values"
            print_info "Timer will use new settings on next restart"
        else
            print_error "Failed to regenerate systemd services"
            return 1
        fi
    else
        print_error "Service generation script not found: $generate_script"
        print_info "Try reinstalling wallflow or run 'make install'"
        return 1
    fi
}

# Test configuration by running wallflow command
test_config() {
    print_header "Testing wallflow Configuration"

    if ! validate_config; then
        print_error "Configuration validation failed, aborting test"
        return 1
    fi

    echo ""
    print_header "Testing wallflow command..."

    if command -v wallflow >/dev/null 2>&1; then
        echo "Running: wallflow config"
        wallflow config

        echo ""
        read -p "Test with a real wallpaper change? [y/N]: " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "Running: wallflow local"
            wallflow local || print_warning "Test failed - check wallflow installation and local wallpapers"
        fi
    else
        print_error "wallflow command not found"
        print_warning "Make sure wallflow is installed and in your PATH"
        return 1
    fi
}

# Show configuration paths and info
info() {
    print_header "wallflow Configuration Info"

    echo "Configuration:"
    echo "  Config file: $CONFIG_FILE"
    echo "  Config dir: $CONFIG_DIR"
    echo "  Exists: $(if [[ -f "$CONFIG_FILE" ]]; then echo "‚úÖ Yes"; else echo "‚ùå No"; fi)"

    if [[ -f "$CONFIG_FILE" ]]; then
        echo "  Size: $(du -h "$CONFIG_FILE" | cut -f1)"
        echo "  Modified: $(date -r "$CONFIG_FILE" '+%Y-%m-%d %H:%M:%S')"
    fi

    echo ""
    echo "Installation:"
    local wallflow_dir
    wallflow_dir=$(get_wallflow_dir)
    echo "  wallflow dir: $wallflow_dir"
    echo "  wallflow command: $(command -v wallflow || echo "Not found")"
    echo "  Template config: $wallflow_dir/config/wallflow.yml"

    echo ""
    echo "Dependencies:"
    local deps=("awww" "awww-daemon" "wal" "jq" "curl" "yq")
    for dep in "${deps[@]}"; do
        if command -v "$dep" >/dev/null 2>&1; then
            echo "  $dep: ‚úÖ $(command -v "$dep")"
        else
            echo "  $dep: ‚ùå Not found"
        fi
    done
}

# Show usage
usage() {
    echo "üåä wallflow-config - Configuration management for wallflow"
    echo ""
    echo "Usage: $0 COMMAND"
    echo ""
    echo "Commands:"
    echo "  init       Initialize configuration from template"
    echo "  show       Show current configuration"
    echo "  edit       Edit configuration file"
    echo "  validate   Validate configuration syntax and values"
    echo "  test       Test configuration by running wallflow"
    echo "  regenerate Regenerate systemd services from config"
    echo "  info       Show configuration and system information"
    echo "  help       Show this help message"
    echo ""
    echo "Config file: $CONFIG_FILE"
    echo ""
    echo "Examples:"
    echo "  wallflow-config init      # Create initial configuration"
    echo "  wallflow-config edit      # Edit in your default editor"
    echo "  wallflow-config validate  # Check for errors"
    echo "  wallflow-config test      # Test with actual wallpaper change"
}

# Main execution
case "${1:-help}" in
    init|initialize)
        init_config
        ;;
    show|config|cat)
        show_config
        ;;
    edit)
        edit_config
        ;;
    validate|check)
        validate_config
        ;;
    test)
        test_config
        ;;
    regenerate|regen)
        regenerate_services
        ;;
    info)
        info
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Unknown command: $1"
        echo ""
        usage
        exit 1
        ;;
esac